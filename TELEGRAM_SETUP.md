# Подробная инструкция по настройке системы верификации через Telegram

## Содержание

1. [Общие требования](#общие-требования)
2. [Создание Telegram бота](#создание-telegram-бота)
3. [Настройка переменных окружения](#настройка-переменных-окружения)
4. [Настройка вебхука Telegram](#настройка-вебхука-telegram)
5. [Проверка работы системы](#проверка-работы-системы)
6. [Решение проблем](#решение-проблем)
7. [Дополнительные настройки](#дополнительные-настройки)

---

## Общие требования

### Системные требования

- PHP 8.3.6 или выше
- Laravel 12
- Composer
- Доступ к серверу с поддержкой HTTPS (для вебхука)
- Telegram аккаунт

### Что нужно знать перед началом

- **Домен вашего сайта** - должен быть доступен по HTTPS (например: `https://restaurant.com`)
- **Доступ к серверу** - для настройки вебхука нужен доступ к серверу или возможность использовать инструменты командной строки
- **Базовое понимание работы с командной строкой** - для выполнения некоторых команд

---

## Создание Telegram бота

### Шаг 1: Поиск BotFather

1. Откройте приложение Telegram на вашем устройстве (мобильное приложение или веб-версия)
2. В строке поиска введите `@BotFather` (с символом @)
3. Нажмите на найденного бота `@BotFather` (должна быть синяя галочка, означающая официального бота)

### Шаг 2: Создание нового бота

1. Нажмите кнопку **"Start"** или отправьте команду `/start` боту `@BotFather`
2. Вы увидите список доступных команд. Отправьте команду `/newbot`
3. BotFather попросит ввести **имя бота** (отображаемое имя):
   ```
   Например: Restaurant Verification Bot
   ```
   Это имя будет видно пользователям в списке чатов
4. Затем BotFather попросит ввести **username бота**:
   ```
   Например: restaurant_verification_bot
   ```
   **Важно:**
   - Username должен быть уникальным
   - Должен заканчиваться на `bot` (например: `my_bot`, `restaurant_bot`)
   - Может содержать только латинские буквы, цифры и подчеркивания
   - Не может содержать пробелы или специальные символы

### Шаг 3: Получение токена

После успешного создания бота, BotFather отправит вам сообщение с **токеном бота**.

Пример сообщения:
```
Done! Congratulations on your new bot. You will find it at t.me/restaurant_verification_bot. Use this token to access the HTTP API:

123456789:ABCdefGHIjklMNOpqrsTUVwxyz-1234567890

Keep your token secure and store it safely, it can be used by anyone to control your bot.
```

**ВАЖНО:** 
- Сохраните этот токен в безопасном месте
- Никогда не публикуйте токен в публичных репозиториях
- Если токен будет скомпрометирован, создайте нового бота через `/newbot`

### Шаг 4: Сохранение информации о боте

Запишите следующую информацию:
- **Токен бота**: `123456789:ABCdefGHIjklMNOpqrsTUVwxyz-1234567890`
- **Username бота**: `restaurant_verification_bot` (без символа @)

Эти данные понадобятся для настройки системы.

---

## Настройка переменных окружения

### Шаг 1: Открытие файла .env

1. Найдите файл `.env` в корневой директории вашего проекта Laravel
2. Откройте его в текстовом редакторе

**Примечание:** Если файла `.env` нет, скопируйте файл `.env.example` и переименуйте его в `.env`

### Шаг 2: Добавление переменных

Добавьте следующие строки в конец файла `.env`:

```env
# Telegram Bot Configuration
TELEGRAM_BOT_TOKEN=ваш_токен_от_BotFather
TELEGRAM_BOT_USERNAME=ваш_username_бота_без_@
TELEGRAM_WEBHOOK_URL=https://ваш_домен/api/telegram/webhook

# Verification Settings
VERIFICATION_CODE_EXPIRES_MINUTES=10
VERIFICATION_MAX_ATTEMPTS=3
```

### Шаг 3: Заполнение значений

Замените значения на ваши реальные данные:

#### TELEGRAM_BOT_TOKEN
```
Пример: TELEGRAM_BOT_TOKEN=123456789:ABCdefGHIjklMNOpqrsTUVwxyz-1234567890
```
- Вставьте токен, полученный от BotFather
- Не добавляйте кавычки вокруг значения
- Не добавляйте пробелы до или после знака `=`

#### TELEGRAM_BOT_USERNAME
```
Пример: TELEGRAM_BOT_USERNAME=restaurant_verification_bot
```
- Вставьте username бота БЕЗ символа @
- Только строчные буквы, цифры и подчеркивания
- Должен заканчиваться на `bot`

#### TELEGRAM_WEBHOOK_URL
```
Пример: TELEGRAM_WEBHOOK_URL=https://restaurant.com/api/telegram/webhook
```
- Замените `restaurant.com` на ваш реальный домен
- URL должен начинаться с `https://` (HTTP не поддерживается Telegram)
- Путь должен быть `/api/telegram/webhook`
- Убедитесь, что домен доступен из интернета

#### VERIFICATION_CODE_EXPIRES_MINUTES
```
Пример: VERIFICATION_CODE_EXPIRES_MINUTES=10
```
- Время жизни кода подтверждения в минутах
- Рекомендуемое значение: 10 минут
- Минимальное значение: 1 минута
- Максимальное значение: 60 минут

#### VERIFICATION_MAX_ATTEMPTS
```
Пример: VERIFICATION_MAX_ATTEMPTS=3
```
- Максимальное количество попыток ввода кода
- Рекомендуемое значение: 3
- Минимальное значение: 1
- Максимальное значение: 10

### Шаг 4: Сохранение файла

1. Сохраните файл `.env`
2. Убедитесь, что файл сохранен в правильной кодировке (UTF-8)

### Шаг 5: Очистка кэша конфигурации

Выполните в терминале (если используете кэширование конфигурации):

```bash
php artisan config:clear
php artisan cache:clear
```

---

## Настройка вебхука Telegram

### Что такое вебхук?

Вебхук (webhook) - это способ, которым Telegram отправляет обновления (сообщения, команды) вашему серверу в реальном времени. Когда пользователь взаимодействует с ботом, Telegram отправляет HTTP POST запрос на указанный URL.

### Почему нужен HTTPS?

Telegram требует, чтобы вебхук использовал HTTPS (защищенное соединение). Это необходимо для безопасности данных пользователей.

### Шаг 1: Проверка доступности URL

Перед настройкой вебхука убедитесь, что ваш сайт доступен по HTTPS:

1. Откройте браузер
2. Перейдите по адресу: `https://ваш_домен/api/telegram/webhook`
3. Вы должны увидеть ответ (даже если это ошибка 405 или 404, это нормально - главное, что сайт доступен)

**Если сайт не доступен по HTTPS:**
- Настройте SSL сертификат (Let's Encrypt, Cloudflare и т.д.)
- Убедитесь, что сервер правильно настроен для HTTPS

### Шаг 2: Получение токена бота

Убедитесь, что у вас есть токен бота из файла `.env`:
```env
TELEGRAM_BOT_TOKEN=123456789:ABCdefGHIjklMNOpqrsTUVwxyz-1234567890
```

### Шаг 3: Настройка вебхука через командную строку

#### Вариант 1: Использование curl (рекомендуется)

Откройте терминал и выполните команду:

```bash
curl -X POST "https://api.telegram.org/botВАШ_ТОКЕН/setWebhook?url=https://ВАШ_ДОМЕН/api/telegram/webhook"
```

**Замените:**
- `ВАШ_ТОКЕН` - токен бота из `.env` (например: `123456789:ABCdefGHIjklMNOpqrsTUVwxyz-1234567890`)
- `ВАШ_ДОМЕН` - ваш домен (например: `restaurant.com`)

**Пример команды:**
```bash
curl -X POST "https://api.telegram.org/bot123456789:ABCdefGHIjklMNOpqrsTUVwxyz-1234567890/setWebhook?url=https://restaurant.com/api/telegram/webhook"
```

**Ожидаемый ответ при успехе:**
```json
{
  "ok": true,
  "result": true,
  "description": "Webhook was set"
}
```

**Если вы получили ошибку:**
- Проверьте правильность токена
- Убедитесь, что URL начинается с `https://`
- Проверьте, что домен доступен из интернета

#### Вариант 2: Использование PowerShell (Windows)

Если вы используете Windows и curl недоступен, используйте PowerShell:

```powershell
$token = "ВАШ_ТОКЕН"
$url = "https://ВАШ_ДОМЕН/api/telegram/webhook"
Invoke-WebRequest -Uri "https://api.telegram.org/bot$token/setWebhook?url=$url" -Method POST
```

#### Вариант 3: Использование браузера

Вы также можете настроить вебхук через браузер:

1. Откройте браузер
2. Введите в адресной строке:
```
https://api.telegram.org/botВАШ_ТОКЕН/setWebhook?url=https://ВАШ_ДОМЕН/api/telegram/webhook
```
3. Замените `ВАШ_ТОКЕН` и `ВАШ_ДОМЕН` на реальные значения
4. Нажмите Enter
5. Вы должны увидеть JSON ответ с `"ok": true`

### Шаг 4: Проверка настройки вебхука

Выполните команду для проверки текущего вебхука:

```bash
curl "https://api.telegram.org/botВАШ_ТОКЕН/getWebhookInfo"
```

**Ожидаемый ответ:**
```json
{
  "ok": true,
  "result": {
    "url": "https://restaurant.com/api/telegram/webhook",
    "has_custom_certificate": false,
    "pending_update_count": 0
  }
}
```

**Проверьте:**
- `url` должен совпадать с вашим URL
- `pending_update_count` показывает количество ожидающих обновлений (должно быть 0 или небольшое число)

### Шаг 5: Тестирование вебхука

1. Откройте Telegram
2. Найдите вашего бота по username (например: `@restaurant_verification_bot`)
3. Нажмите "Start" или отправьте команду `/start`
4. Бот должен ответить сообщением

**Если бот не отвечает:**
- Проверьте логи Laravel: `storage/logs/laravel.log`
- Проверьте, что вебхук настроен правильно
- Убедитесь, что маршрут `/api/telegram/webhook` доступен

### Шаг 6: Удаление вебхука (если нужно)

Если нужно удалить вебхук (например, для переключения на polling):

```bash
curl -X POST "https://api.telegram.org/botВАШ_ТОКЕН/deleteWebhook"
```

---

## Проверка работы системы

### Шаг 1: Проверка конфигурации

Убедитесь, что все переменные окружения установлены правильно:

```bash
php artisan tinker
```

В tinker выполните:
```php
config('verification.telegram.bot_token')
config('verification.telegram.bot_username')
config('verification.code_expires_minutes')
config('verification.max_attempts')
```

Все значения должны быть заполнены и корректны.

### Шаг 2: Проверка маршрутов

Убедитесь, что маршруты зарегистрированы:

```bash
php artisan route:list | grep telegram
php artisan route:list | grep verification
```

Должны быть видны маршруты:
- `POST /api/telegram/webhook`
- `POST /api/phone/verification/start`
- `POST /api/phone/verification/verify`

### Шаг 3: Тестирование создания заказа

1. Откройте сайт в браузере
2. Добавьте товары в корзину
3. Нажмите "Оформить заказ"
4. Заполните форму заказа
5. После создания заказа должно появиться модальное окно с кнопкой "Открыть Telegram бота"

### Шаг 4: Тестирование верификации

1. В модальном окне нажмите "Открыть Telegram бота"
2. В Telegram нажмите "Start" или отправьте `/start`
3. Бот должен отправить код подтверждения
4. Вернитесь на сайт и введите код
5. Заказ должен быть подтвержден

### Шаг 5: Проверка логов

Если что-то не работает, проверьте логи:

```bash
tail -f storage/logs/laravel.log
```

Или в браузере (если используете Laravel Debugbar):
- Откройте консоль разработчика (F12)
- Проверьте вкладку Network для HTTP запросов
- Проверьте вкладку Console для JavaScript ошибок

---

## Решение проблем

### Проблема 1: Вебхук не работает

**Симптомы:**
- Бот не отвечает на сообщения
- В логах ошибки подключения

**Решения:**

1. **Проверьте доступность URL:**
   ```bash
   curl -I https://ваш_домен/api/telegram/webhook
   ```
   Должен вернуться HTTP статус (200, 404, 405 - все нормально, главное что сайт доступен)

2. **Проверьте SSL сертификат:**
   ```bash
   openssl s_client -connect ваш_домен:443
   ```
   Сертификат должен быть валидным

3. **Проверьте настройки вебхука:**
   ```bash
   curl "https://api.telegram.org/botВАШ_ТОКЕН/getWebhookInfo"
   ```

4. **Проверьте логи Laravel:**
   ```bash
   tail -f storage/logs/laravel.log
   ```

### Проблема 2: Бот не отправляет код

**Симптомы:**
- Пользователь нажимает "Start" в боте, но код не приходит

**Решения:**

1. **Проверьте токен бота:**
   - Убедитесь, что токен правильный в `.env`
   - Выполните `php artisan config:clear`

2. **Проверьте Chat ID:**
   - Убедитесь, что пользователь правильно взаимодействует с ботом
   - Проверьте логи для ошибок отправки

3. **Проверьте лимиты Telegram API:**
   - Telegram имеет лимиты на отправку сообщений
   - Проверьте, не превышены ли лимиты

### Проблема 3: Код не проходит проверку

**Симптомы:**
- Пользователь вводит код, но получает ошибку

**Решения:**

1. **Проверьте время жизни кода:**
   - Код действителен только в течение указанного времени
   - Убедитесь, что пользователь вводит код вовремя

2. **Проверьте количество попыток:**
   - После превышения лимита попыток нужно создать новую верификацию
   - Проверьте настройку `VERIFICATION_MAX_ATTEMPTS`

3. **Проверьте базу данных:**
   - Убедитесь, что таблица `phone_verifications` создана
   - Проверьте, что записи создаются правильно

### Проблема 4: Ошибки в консоли браузера

**Симптомы:**
- JavaScript ошибки в консоли
- Модальное окно не открывается

**Решения:**

1. **Проверьте консоль браузера (F12):**
   - Ищите ошибки JavaScript
   - Проверьте Network вкладку для ошибок API

2. **Проверьте CSRF токен:**
   - Убедитесь, что в HTML есть `<meta name="csrf-token">`
   - Проверьте, что токен передается в запросах

3. **Очистите кэш браузера:**
   - Нажмите Ctrl+F5 для жесткой перезагрузки
   - Или очистите кэш браузера

### Проблема 5: Ошибки базы данных

**Симптомы:**
- Ошибки при создании заказа или верификации

**Решения:**

1. **Проверьте миграции:**
   ```bash
   php artisan migrate:status
   ```
   Все миграции должны быть выполнены

2. **Выполните миграции заново (если нужно):**
   ```bash
   php artisan migrate:fresh
   ```
   **ВНИМАНИЕ:** Это удалит все данные из базы!

3. **Проверьте права доступа к базе данных:**
   - Убедитесь, что пользователь БД имеет права на запись
   - Проверьте настройки в `.env`

---

## Дополнительные настройки

### Настройка команд бота

Вы можете настроить список команд, которые будет показывать бот:

1. Откройте Telegram
2. Найдите `@BotFather`
3. Отправьте `/setcommands`
4. Выберите вашего бота
5. Отправьте список команд, например:
```
start - Начать работу с ботом
help - Получить помощь
```

### Настройка описания бота

1. Найдите `@BotFather`
2. Отправьте `/setdescription`
3. Выберите вашего бота
4. Отправьте описание, например:
```
Бот для подтверждения заказов в ресторане. Используйте для получения кодов подтверждения.
```

### Настройка изображения бота

1. Найдите `@BotFather`
2. Отправьте `/setuserpic`
3. Выберите вашего бота
4. Отправьте изображение (до 10 МБ)

### Использование ngrok для локальной разработки

Если вы разрабатываете локально и нужен HTTPS для вебхука:

1. Установите ngrok: https://ngrok.com/
2. Запустите локальный сервер:
   ```bash
   php artisan serve
   ```
3. В другом терминале запустите ngrok:
   ```bash
   ngrok http 8000
   ```
4. Скопируйте HTTPS URL (например: `https://abc123.ngrok.io`)
5. Используйте этот URL для вебхука:
   ```bash
   curl -X POST "https://api.telegram.org/botВАШ_ТОКЕН/setWebhook?url=https://abc123.ngrok.io/api/telegram/webhook"
   ```

**Важно:** URL ngrok меняется при каждом запуске (на бесплатном плане)

### Мониторинг вебхука

Для мониторинга работы вебхука можно использовать:

1. **Проверка статуса:**
   ```bash
   curl "https://api.telegram.org/botВАШ_ТОКЕН/getWebhookInfo"
   ```

2. **Логи Laravel:**
   ```bash
   tail -f storage/logs/laravel.log
   ```

3. **Логи веб-сервера:**
   - Nginx: `/var/log/nginx/access.log`
   - Apache: `/var/log/apache2/access.log`

---

## Безопасность

### Рекомендации по безопасности

1. **Никогда не публикуйте токен бота:**
   - Не коммитьте `.env` в Git
   - Используйте `.env.example` для примера
   - Добавьте `.env` в `.gitignore`

2. **Используйте HTTPS:**
   - Всегда используйте HTTPS для вебхука
   - Настройте SSL сертификат

3. **Ограничьте доступ к вебхуку:**
   - Можно добавить проверку IP адресов Telegram
   - Используйте middleware для защиты маршрута

4. **Регулярно проверяйте логи:**
   - Мониторьте подозрительную активность
   - Проверяйте ошибки

5. **Обновляйте зависимости:**
   - Регулярно обновляйте Laravel и пакеты
   - Используйте `composer update` для обновлений

---

## Заключение

После выполнения всех шагов ваша система верификации через Telegram должна работать корректно. Если у вас возникли проблемы, проверьте:

1. Правильность всех настроек в `.env`
2. Доступность сайта по HTTPS
3. Правильность настройки вебхука
4. Логи Laravel для ошибок

Для получения дополнительной помощи обратитесь к документации:
- Telegram Bot API: https://core.telegram.org/bots/api
- Laravel Documentation: https://laravel.com/docs

---

**Дата создания:** 2025-12-16  
**Версия:** 1.0